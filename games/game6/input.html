<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Hebrew UI</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .button-wrapper {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        .btn-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .circle-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid #000;
            font-size: 28px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            cursor: pointer;
        }

        .btn-text {
            font-size: 16px;
            font-weight: bold;
        }

        .btn-text.red {
            color: red;
        }

        .audio-btn:hover {
            color: #9ee782;
        }

        .main {
            display: flex;
            gap: 150px;
        }

        .letter-box {
            width: 80px;
            height: 80px;
            border: 2px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 20px;
            position: relative;
        }

        .dropdowns {
            display: flex;
            gap: 10px;
        }

        select {
            font-size: 22px;
            height: 158px;
            direction: rtl;
            border: 2px solid black;
            padding: 5px;
            width: 55px;
        }

        option {
            font-size: 20px;
        }

        .fixedLetter {
            border: 2px solid red;
        }

        .savebtn {
            height: 36px;
            width: 100px;
            position: fixed;
            bottom: 10px;
            right: 40px;
            background: linear-gradient(to right, #4CAF50, #45A049);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .savebtn:hover {
            background: linear-gradient(to right, #45A049, #4CAF50);
            transform: scale(1.05);
        }

        .letter-container {
            position: relative;
        }

        .remove-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 25px;
            height: 25px;
            background: red;
            color: white;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid white;
            z-index: 10;
        }

        .letter-container:hover .remove-btn {
            display: flex;
        }

        #mainLetterContainer {
            display: flex;
            flex-direction: row;
            gap: 20px;
        }

        .random-row {
            display: none; /* Hide randomizer slides from UI */
        }

        .font-family {
            font-family: 'Times New Roman', serif;
        }
        
        .slide-indicator {
            position: absolute;
            top: -25px;
            left: 0;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>

<body>
    <div class="main">
        <div class="button-wrapper">
            <div class="btn-row">
                <div class="circle-btn" onclick="addLetter('letter')">+</div>
                <div class="btn-text">ADD 1 LETTER</div>
            </div>
            <div class="btn-row">
                <div class="circle-btn" onclick="addLetter('fixed')">+</div>
                <div class="btn-text red">ADD FIXED</div>
            </div>
            <div class="btn-row">
                <label class="circle-btn audio-btn" for="audioUpload">+</label>
                <div class="btn-text">UPLOAD AUDIO</div>
                <input type="file" id="audioUpload" accept="audio/*" style="display: none;" />
            </div>
            <div class="btn-row">
                <div class="circle-btn" onclick="generateRandomSlides()">+</div>
                <div class="btn-text red">ADD RANDOMIZER</div>
                <input type="number" id="shuffleCount" value="2" min="1" style="width: 60px;" />
            </div>            
        </div>

        <div id="mainLetterContainer">
            <div class="mainbody" style="display: none;" id="AddNewLetter">
                <div class="letter-container">
                    <div class="remove-btn" onclick="removeLetterContainer(this)">×</div>
                    <div class="letter-box font-family" id="mainLetter"></div>
                    <div id="hebrewNikardList" class="dropdowns">
                        <select class="hebrewNikudList" id="hebrewNikuds" size="6"></select>
                        <select class="hebrewLetterList" id="hebrewLetters" size="6"></select>
                    </div>
                </div>
            </div>
        </div>
        <button class="savebtn" onclick="downloadAsJSON()" style="right: 160px;">Download JSON</button>
        <button class="savebtn" onclick="saveAllValues()">Save</button>
    </div>

    <script>
        let letters = 0;
        let slideCounter = 1;
        window.uploadedFiles = [];
        const hebrewLetters = ["א", "בּ", "ב", "ג", "ד", "ה", "ו", "ז", "ח", "ט", "י", "כּ", "כ", "ךּ", "ך", "ל", "מ", "ם", "נ", "ן", "ס", "ע", "פּ", "פ", "ףּ", "ף", "צ", "ץ", "ק", "ר", "שׁ", "שׂ", "תּ", "ת"];
        for (let i = 0; i < hebrewLetters.length; i++) {
            const html = '<option onclick="getLetterValue(this)" class="font-family">' + hebrewLetters[i] + '</option>';
            document.getElementById('hebrewLetters').innerHTML += html;
        }
        const hebrewNikuds = ["ָ", "ַ", "ֵ", "ֶ", "ִ", "ֹ", "ֻ", "ְ", "ֳ", "ֲ", "ֱ", "ּ"];
        for (let i = 0; i < hebrewNikuds.length; i++) {
            const html = '<option onclick="getNikudValue(this)" class="font-family">' + hebrewNikuds[i] + '</option>';
            document.getElementById('hebrewNikuds').innerHTML += html;
        }

        // Store randomized slides in memory
        let randomizedSlides = [];

        function addLetter(type) {
            const mainLetter = document.getElementById('AddNewLetter');
            const copy = mainLetter.cloneNode(true);

            copy.id = "NewLetter" + (letters + 1);
            const inner = copy.getElementsByClassName('letter-box')[0];
            const letterList = copy.getElementsByClassName('hebrewLetterList')[0];
            if (letterList) letterList.removeAttribute("id");

            if (type === 'fixed') {
                if (inner) inner.classList.add("fixedLetter");
            } else {
                if (inner) inner.classList.add("newLetter");
            }

            // Add slide indicator
            const indicator = document.createElement('div');
            indicator.className = 'slide-indicator';
            indicator.textContent = 'Slide ' + slideCounter;
            copy.getElementsByClassName('letter-container')[0].appendChild(indicator);

            copy.style.display = 'block';
            letters++;
            document.getElementById('mainLetterContainer').appendChild(copy);
        }

        function getLetterValue(el) {
            const value = el.value;
            el.parentNode.parentNode.parentNode.getElementsByClassName('letter-box')[0].innerHTML = value;
        }
       
        function getNikudValue(el) {
            const newLetters = []
            const mainArea = el.parentNode.parentNode.parentNode.getElementsByClassName('letter-box')[0]
            const viewArea = mainArea.innerHTML
            for(let i=0; i<viewArea.length; i ++){
                if(!hebrewNikuds.includes(viewArea[i]))
                    newLetters.push(viewArea[i])
            }
            const value = el.value;
            newLetters.push(value)
            mainArea.innerHTML = ''

            for(let i =0; i<newLetters.length; i++){
                mainArea.innerHTML += newLetters[i];
            }
        }

        function removeLetterContainer(btn) {
            const container = btn.closest('.letter-container').parentNode;
            container.parentNode.removeChild(container);
        }

        function saveAllValues() {
            const inputData = generateJSONData();
            console.log("Sending inputData:", inputData);

            try {
                window.parent.postMessage(
                    {
                        type: "saveValues",
                        inputData,
                    },
                    window.origin
                );
                console.log("postMessage sent successfully");
            } catch (error) {
                console.error("Error sending postMessage:", error);
                alert("Failed to send data to parent window.");
            }

            alert("Values saved! Check console for details.");
        }

        // Handle audio upload
        document.getElementById("audioUpload").addEventListener("change", function () {
            const file = this.files[0];
            if (file) {
                window.uploadedFiles.push(file);
            }
        });

        function shuffleArray(array) {
            // Fisher-Yates Shuffle
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        function generateRandomSlides() {
            const count = parseInt(document.getElementById('shuffleCount').value) || 1;
            const originalContainers = Array.from(
                document.querySelectorAll("#mainLetterContainer > .mainbody:not(#AddNewLetter)")
            );

            if (originalContainers.length === 0) {
                alert("Add letters first to shuffle.");
                return;
            }

            // Clear previous randomized slides
            randomizedSlides = [];

            // Create new slide data for each randomization
            for (let i = 0; i < count; i++) {
                const shuffledContainers = shuffleArray([...originalContainers]);
                const slideLetters = [];
                
                shuffledContainers.forEach(container => {
                    const box = container.querySelector('.letter-box');
                    if (box && box.textContent.trim()) {
                        const isFixed = box.classList.contains("fixedLetter");
                        slideLetters.push({
                            value: box.textContent,
                            type: isFixed ? "fixed" : "letter"
                        });
                    }
                });
                
                if (slideLetters.length > 0) {
                    randomizedSlides.push({
                        letters: slideLetters
                    });
                }
            }

        }

        function generateJSONData() {
            const slides = [];
            
            // Add the original slide
            const originalContainers = document.querySelectorAll('#mainLetterContainer > .mainbody:not(#AddNewLetter)');
            if (originalContainers.length > 0) {
                const originalLetters = [];
                
                originalContainers.forEach(container => {
                    const box = container.querySelector('.letter-box');
                    if (box && box.textContent.trim()) {
                        const isFixed = box.classList.contains("fixedLetter");
                        originalLetters.push({
                            value: box.textContent,
                            type: isFixed ? "fixed" : "letter"
                        });
                    }
                });
                
                if (originalLetters.length > 0) {
                    slides.push({
                        letters: originalLetters
                    });
                }
            }
            
            // Add the randomized slides
            slides.push(...randomizedSlides);

            return {
                slides: slides,
                qaudio: window.uploadedFiles.length > 0 ? window.uploadedFiles[0].name : "question.mp3"
            };
        }

        function downloadAsJSON() {
            const inputData = generateJSONData();
            
            const blob = new Blob([JSON.stringify(inputData, null, 4)], {
                type: "application/json",
            });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = "input.json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>