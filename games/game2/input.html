<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Teacher PDF Upload</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        font-family: sans-serif;
        height: 100vh;
        overflow: hidden;
        background: #f1f1f1;
      }

      #container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        padding: 20px;
        box-sizing: border-box;
      }

      #upload-area {
        background: rgba(255, 255, 255, 0.95);
        border: 2px solid #ccc;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        max-width: 600px;
        width: 100%;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      #upload-area h2 {
        margin: 0 0 20px;
        font-size: 24px;
        color: #333;
      }

      #file-input {
        display: none;
      }

      #file-label {
        display: inline-block;
        padding: 10px 20px;
        background: #0f9d58;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      #file-label:hover {
        background: #0c7b46;
      }

      #file-list {
        margin: 20px 0;
        max-height: 300px;
        overflow-y: auto;
        width: 100%;
        text-align: left;
      }

      .file-item {
        display: flex;
        align-items: center;
        padding: 8px;
        border-bottom: 1px solid #eee;
        color: #333;
      }

      .file-item canvas {
        width: 100px;
        height: 100px;
        margin-right: 10px;
        border: 1px solid #ccc;
        background: #fff;
      }

      .file-item span {
        flex-grow: 1;
      }

      #generate-btn {
        padding: 10px 20px;
        background: #f4b400;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      #generate-btn:hover {
        background: #d39e00;
      }

      #generate-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      #status {
        margin-top: 20px;
        color: #333;
        font-size: 14px;
      }
    </style>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    </script>
  </head>
  <body>
    <div id="container">
      <div id="upload-area">
        <h2>Upload PDF Files</h2>
        <input type="file" id="file-input" accept="application/pdf" multiple />
        <label for="file-input" id="file-label">Select Multiple PDF Files</label>
        <div id="file-list"></div>
        <button id="generate-btn" disabled>Create input.json</button>
        <div id="status"></div>
      </div>
    </div>

    <script>
      const fileInput = document.getElementById("file-input");
      const fileListDiv = document.getElementById("file-list");
      const generateBtn = document.getElementById("generate-btn");
      const statusDiv = document.getElementById("status");
      let uploadedFiles = [];

      fileInput.addEventListener("change", async (e) => {
        uploadedFiles = Array.from(e.target.files).filter((file) =>
          file.type === "application/pdf"
        );
        console.log("Selected files:", uploadedFiles.map(file => file.name)); // Debug log
        await updateFileList();
        generateBtn.disabled = uploadedFiles.length === 0;
        statusDiv.textContent = uploadedFiles.length > 0 
          ? `${uploadedFiles.length} PDF file(s) selected` 
          : "No PDF files selected";
      });

      async function updateFileList() {
        fileListDiv.innerHTML = "";
        if (uploadedFiles.length === 0) {
          fileListDiv.innerHTML = "<div>No PDF files selected</div>";
          return;
        }

        for (const file of uploadedFiles) {
          const div = document.createElement("div");
          div.className = "file-item";

          // Create canvas for PDF preview
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");

          // Create span for file name
          const span = document.createElement("span");
          span.textContent = file.name;

          // Append elements to file item
          div.appendChild(canvas);
          div.appendChild(span);
          fileListDiv.appendChild(div);

          // Render PDF preview
          try {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const page = await pdf.getPage(1);
            const viewport = page.getViewport({ scale: 0.2 }); // Small scale for preview
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            await page.render({
              canvasContext: ctx,
              viewport: viewport
            }).promise;
          } catch (error) {
            console.error(`Error rendering preview for ${file.name}:`, error);
            span.textContent += " (Preview failed)";
          }
        }
      }

      generateBtn.addEventListener("click", () => {
        if (uploadedFiles.length === 0) {
          statusDiv.textContent = "Please select at least one PDF file.";
          return;
        }

        // Generate input.json content
        const fileNames = uploadedFiles.map((file) => file.name);
        const inputJsonContent = `{\npdfFiles: [\n  "${fileNames.join('",\n  "')}"\n]\n}`;

        // Create downloadable input.json file
        const blob = new Blob([inputJsonContent], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "input.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        statusDiv.textContent = "input.json generated! Download it and place it in your project directory. Move the selected PDFs to the 'pdfs/' folder.";
      });

      // Access game-specific data
    const gameData = window.parent.currentGameData || { letters: ['A', 'B', 'C'] };
    document.getElementById('gameContent').textContent = `Match these letters: ${gameData.letters?.join(', ') || 'No data'}`;

    function completeGame() {
      window.parent.postMessage({ type: 'gameComplete', score: 90 }, '*');
    }
    </script>
  </body>
</html>