<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Student Game</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #gameArea {
      position: relative;
      width: 100vw;
      height: 100vh;
      background-size: cover;
      background-position: center;
    }
    .object {
      position: absolute;
      width: 100px;
      height: 100px;
      background-repeat: no-repeat;
      background-size: contain;
      transition: transform 0.25s ease;
      animation: float 6s infinite ease-in-out;
      cursor: pointer;
    }
    .clicked { filter: drop-shadow(0 0 8px red); }
    .original.clicked { filter: drop-shadow(0 0 8px limegreen); }

    @keyframes float {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(1deg); }
      50% { transform: rotate(-1deg); }
      75% { transform: rotate(0.5deg); }
    }
  </style>

</head>
<body>
  <div id="gameArea"></div>
  <audio id="clickSound"></audio>
  
  <script src="input.js"></script>
  <script>
    const gameArea = document.getElementById("gameArea");
    const clickSound = document.getElementById("clickSound");

    gameArea.style.background = `url('${inputData.background.name}') no-repeat center center`;
    gameArea.style.backgroundSize = 'cover';
    clickSound.src = inputData.clickSound.name;

    const objects = [];
    const originalObjects = [];
    let correctClicks = 0;

    function handleClick(e) {
      const clickedEl = e.target;
      clickSound.play();
      clickedEl.classList.add("clicked");
      setTimeout(() => clickedEl.classList.remove("clicked"), 300);

      if (clickedEl.classList.contains("original") && !clickedEl.clicked) {
        clickedEl.clicked = true;
        correctClicks++;

        if (correctClicks === inputData.correctObjects) {
          console.log("Game completed! All correct objects clicked.");
          scormHandler.finish(true); 
        }
      }
    }

    function moveAllObjects() {
      for (let i = 0; i < objects.length; i++) {
        const obj = objects[i];
        obj.x += obj.vx;
        obj.y += obj.vy;

        if (obj.x <= 0 || obj.x >= gameArea.clientWidth - 100) obj.vx *= -1;
        if (obj.y <= 0 || obj.y >= gameArea.clientHeight - 100) obj.vy *= -1;

        obj.x = Math.max(0, Math.min(obj.x, gameArea.clientWidth - 100));
        obj.y = Math.max(0, Math.min(obj.y, gameArea.clientHeight - 100));
        obj.el.style.left = `${obj.x}px`;
        obj.el.style.top = `${obj.y}px`;
      }

      // Simple collision bounce
      for (let i = 0; i < objects.length; i++) {
        for (let j = i + 1; j < objects.length; j++) {
          const a = objects[i];
          const b = objects[j];
          const dx = b.x - a.x;
          const dy = b.y - a.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < 70) {
            const angle = Math.atan2(dy, dx);
            const speedA = Math.sqrt(a.vx ** 2 + a.vy ** 2);
            const speedB = Math.sqrt(b.vx ** 2 + b.vy ** 2);
            a.vx = -Math.cos(angle) * speedB;
            a.vy = -Math.sin(angle) * speedB;
            b.vx = Math.cos(angle) * speedA;
            b.vy = Math.sin(angle) * speedA;
          }
        }
      }

      requestAnimationFrame(moveAllObjects);
    }

    function createObject(isNew) {
      const el = document.createElement("div");
      el.classList.add("object");
      el.style.backgroundImage = `url('${inputData.objectImage.name}')`;
      if (isNew) el.classList.add("new");
      else el.classList.add("original");

      const x = Math.random() * (gameArea.clientWidth - 100);
      const y = Math.random() * (gameArea.clientHeight - 100);
      el.style.left = `${x}px`;
      el.style.top = `${y}px`;

      const velocity = {
        x: (Math.random() - 0.5) * inputData.speed,
        y: (Math.random() - 0.5) * inputData.speed
      };

      el.addEventListener("click", handleClick);
      gameArea.appendChild(el);

      if (!isNew) originalObjects.push(el);
      objects.push({ el, x, y, vx: velocity.x, vy: velocity.y, isNew });
    }

    function startGame() {
      const total = inputData.totalObjects;
      const correct = inputData.correctObjects;

      for (let i = 0; i < correct; i++) {
        createObject(false);
      }

      requestAnimationFrame(moveAllObjects);

      setTimeout(() => {
        for (let i = correct; i < total; i++) {
          createObject(true);
        }
      }, 3000);
    }

    startGame();

    //Scorm Handling

    const scormHandler = {
      API: window.API || window.API_1484_11 || null,
      scormCompleted: false,
      startTime: Date.now(),

      finish(isCorrect) {
        if (!this.API) {
          console.log("SCORM API not found. Skipping LMS finish.");
          return;
        }

        if (this.scormCompleted) {
          console.log("SCORM already marked as completed.");
          return;
        }

        const score = isCorrect ? 100 : 0;
        const status = isCorrect ? "passed" : "failed";

        this.API.LMSSetValue("cmi.core.lesson_status", status);
        this.API.LMSSetValue("cmi.core.score.raw", score);
        this.API.LMSSetValue("cmi.core.score.min", 0);
        this.API.LMSSetValue("cmi.core.score.max", 100);

        const totalSeconds = Math.floor((Date.now() - this.startTime) / 1000);
        const h = String(Math.floor(totalSeconds / 3600)).padStart(2, "0");
        const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, "0");
        const s = String(totalSeconds % 60).padStart(2, "0");
        const sessionTime = `${h}:${m}:${s}`;

        this.API.LMSSetValue("cmi.core.session_time", sessionTime);
        this.API.LMSCommit("");
        const result = this.API.LMSFinish("");

        if (result !== "true") {
          const code = this.API.LMSGetLastError();
          const msg = this.API.LMSGetErrorString(code);
          console.error(`Finish failed: ${msg}`);
        } else {
          console.log(`SCORM Finished: status=${status}, score=${score}`);
        }
        this.scormCompleted = true;
      }
    };

    
  </script>
</body>
</html>
